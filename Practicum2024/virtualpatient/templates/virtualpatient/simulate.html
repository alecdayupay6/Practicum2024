{% extends 'virtualpatient/base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" type="text/css" href="{% static 'simulate1.css' %}">
<body>
    <div class="cnt-1">        
        <div>
            <img alt='bot-icon' src="{% static 'images/simulation.png' %}" class="bot-icon">
        </div>
        <div class="cnt-2">
            <div class="chat-box">
                {% for text in conversation %}
                    {% if text.role == "user" %}
                        <div class="user-message"><p class="user-text">{{ text.content }}</p></div>
                    {% elif text.role == "assistant" %}
                        <div class="bot-message"><p class="bot-text">{{ text.content }}</p></div>
                    {% endif %}
                {% endfor %}
            </div>
            <div class="entry-box">
                <button type="button" id="save">Save</button>
                <textarea class="form-control" id="message-input" placeholder="Type your message here"></textarea>
                <button type="button" id="btn">Send</button>
                <button type="button" id="switch">Switch</button>
            </div>
        </div>
        <div>
            <img alt='user-icon' src="{% static 'images/user.png' %}" class="user-icon">
        </div>        
    </div>
    <script>
        const chatBox = document.querySelector(".chat-box");
        const messageInput = document.querySelector("#message-input");
        const sendBtn = document.querySelector("#btn");
        const saveBtn = document.querySelector("#save");
        const switchBtn = document.querySelector("#switch");
        var provocation = false;
        var quality = false;
        var region = false;
        var severity = false;
        var timing = false;

        function addMessage(message) {
            
        }

        function sendMessage() {
            const message = messageInput.value.trim();
            if (message !== "") {
                const messageDiv = document.createElement("div");
                messageDiv.classList.add("user-message");
                messageDiv.innerHTML = `<p class="user-text">${message}</p>`;
                chatBox.appendChild(messageDiv);
                chatBox.scrollTop = chatBox.scrollHeight;                
                messageInput.value = "";
                fetch("/simulate/{{ pk }}/", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({ message })
                })
                .then(response => response.json())
                .then(data => {
                    const messageDiv = document.createElement("div");
                    messageDiv.classList.add("bot-message");
                    messageDiv.innerHTML = `<p class="bot-text">${data.content}</p>`;
                    chatBox.appendChild(messageDiv);
                    chatBox.scrollTop = chatBox.scrollHeight;
                    try{
                        if (data.content.includes("worsens when")){
                            console.log("provocation");
                            provocation = true;
                        }
                        if (data.content.includes("feels like")){
                            console.log("quality");
                            quality = true;
                        }
                        if (data.content.includes("occurs around")){
                            console.log("region");
                            region = true;
                        }
                        if (data.content.includes("rank")){
                            console.log("severity");
                            severity = true;
                        }
                        if (data.content.includes("experienc")){
                            console.log("timing");
                            timing = true;
                        }
                    }catch{
                        console.log("error in try catch");
                    }
                    console.log(`Provocation: ${provocation}\nQuality: ${quality}\nRegion: ${region}\nSeverity: ${severity}\nTiming: ${timing}`);
                    if (provocation && quality && region && severity && timing){
                        console.log("diagnose me")
                    }
                })
                .catch(error => console.error(error));
            }
        }

        function saveMessage() {
            var texts = document.querySelectorAll(".chat-box>*>*");
            saved = [{"role": "system", "content": "{{ initial }}"}];
            for(i=0;i<texts.length;i++){
                if(texts[i].className=="user-text"){
                    console.log(`User: ${texts[i].textContent}`);
                    saved.push({"role": "user", "content" : texts[i].textContent});
                }else{
                    console.log(`Bot: ${texts[i].textContent}`);
                    saved.push({"role": "assistant", "content" : texts[i].textContent});
                }
            };
            document.cookie = `conversation=${JSON.stringify(saved)}`;
        }

        function switchView(){
            var css = document.getElementsByTagName('link')[1];
            console.log(css);
            if (css.getAttribute('href') == "{% static 'simulate1.css' %}"){
                css.setAttribute('href', "{% static 'simulate2.css' %}");
            } else {
                css.setAttribute('href', "{% static 'simulate1.css' %}");
            }
        }
        
        saveBtn.addEventListener("click", saveMessage);
        switchBtn.addEventListener("click", switchView);
        sendBtn.addEventListener("click", sendMessage);
        messageInput.addEventListener("keydown", event => {
            if (event.keyCode === 13 && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });

    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
</body>
{% endblock %}
